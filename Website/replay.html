<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">

    <title>Replay Page (Prototype)</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css' rel='stylesheet' />

    <link href="css/replay.css" rel="stylesheet">
</head>
<body>

<style>
.overlay {
    position: absolute;
    top: 10px;
    left: 10px;
}

.overlay button {
    font:600 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    background-color: #3386c0;
    color: #fff;
    display: inline-block;
    margin: 0;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    border-radius: 3px;
}

.overlay button:hover {
    background-color:#4ea0da;
}

</style>
<script src='https://npmcdn.com/@turf/turf/turf.min.js' charset='utf-8'></script>

<div id='map'></div>
<div class='overlay'>
    <button id='replay' class="btn-full-gradient">REPLAY</button>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiaXZhbndpZHlhbiIsImEiOiJjaXpvNmx6OXQwMDE0MnFucTJhODNzcnJzIn0.17aFDly4h5iOl-o_21e4yw';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    bearing: -180,
    center: [2.313198, 48.857085],
    zoom: 15.5,
    pitch: 60
});

// San Francisco
var origin = [2.311684, 48.853372];
var finish = [2.311683, 48.853371];

// A simple line from origin to destination.
var route = {
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "geometry": {
            "type": "LineString",
            "coordinates": [
          [
            2.311684,
            48.853372
          ],
          [
            2.311914,
            48.853596
          ],
          [
            2.312147,
            48.853824
          ],
          [
            2.310301,
            48.853917
          ],
          [
            2.30947,
            48.853321
          ],
          [
            2.309921,
            48.857263
          ],
          [
            2.311152,
            48.858119
          ],
          [
            2.311199,
            48.858406
          ],
          [
            2.311927,
            48.85844
          ],
          [
            2.312169,
            48.858452
          ],
          [
            2.31243,
            48.858444
          ],
          [
            2.312469,
            48.858587
          ],
          [
            2.31252,
            48.858674
          ],
          [
            2.312642,
            48.858759
          ],
          [
            2.312768,
            48.858808
          ],
          [
            2.312847,
            48.858815
          ],
          [
            2.312912,
            48.858818
          ],
          [
            2.312966,
            48.858821
          ],
          [
            2.31307,
            48.858811
          ],
          [
            2.313112,
            48.858801
          ],
          [
            2.313198,
            48.858781
          ],
          [
            2.313295,
            48.858735
          ],
          [
            2.313352,
            48.858676
          ],
          [
            2.313396,
            48.858609
          ],
          [
            2.313424,
            48.858532
          ],
          [
            2.313426,
            48.858455
          ],
          [
            2.31342,
            48.858395
          ],
          [
            2.313681,
            48.858372
          ],
          [
            2.31438,
            48.858261
          ],
          [
            2.314561,
            48.858124
          ],
          [
            2.314699,
            48.858042
          ],
          [
            2.315057,
            48.857962
          ],
          [
            2.315184,
            48.857962
          ],
          [
            2.315211,
            48.857852
          ],
          [
            2.31473,
            48.853693
          ],
          [
            2.313349,
            48.853763
          ],
          [
            2.313305,
            48.853644
          ],
          [
            2.313245,
            48.853534
          ],
          [
            2.313185,
            48.853464
          ],
          [
            2.313096,
            48.853393
          ],
          [
            2.312994,
            48.853321
          ],
          [
            2.31286,
            48.853238
          ],
          [
            2.312703,
            48.853176
          ],
          [
            2.312511,
            48.853162
          ],
          [
            2.312311,
            48.85316
          ],
          [
            2.312118,
            48.853181
          ],
          [
            2.311944,
            48.853218
          ],
          [
            2.311809,
            48.853287
          ],
          [
            2.311684,
            48.853372
          ]
        ]
        }
    }]
};

// A single point that animates along the route.
// Coordinates are initially set to origin.
var point = {
    "type": "FeatureCollection",
    "features": [{
        "type": "Feature",
        "properties": {
            "number": "9",
            "name": "SEBASTIAN BUEMI",
            "photo": "http://d3iyn1f5w83nva.cloudfront.net/media/304450/1988103100.png?anchor=center&mode=crop&quality=80&width=170&height=170&rnd=131255171340000000"
          },
        "geometry": {
            "type": "Point",
            "coordinates": origin
        }
    }]
};

// Calculate the distance in kilometers between route start/end point.
var lineDistance = turf.lineDistance(route.features[0], 'meters');

var arc = [];

// Draw an arc between the `origin` & `destination` of the two points
for (var i = 0; i < lineDistance; i++) {
    var segment = turf.along(route.features[0], i / 1000 * lineDistance, 'meters');
    arc.push(segment.geometry.coordinates);
}

// Update the route with calculated arc coordinates
route.features[0].geometry.coordinates = arc;

// Used to increment the value of the point measurement against the route.
var counter = 0;

map.on('load', function () {
    // Add a source and layer displaying a point which will be animated in a circle.
    map.addSource('route', {
        "type": "geojson",
        "data": route
    });

    map.addSource('point', {
        "type": "geojson",
        "data": point
    });

    map.addLayer({
        "id": "route",
        "source": "route",
        "type": "line",
        "paint": {
            "line-width": 2,
            "line-color": "#007cbf"
        }
    });

    map.addLayer({
        "id": "point",
        "source": "point",
        "type": "symbol",
        "layout": {
            "icon-image": "car-15"
        }
    });

    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

    map.on('mousemove', 'point', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(e.features[0].geometry.coordinates)
            .setHTML("<img src=" + e.features[0].properties.photo +
                "/><h2 align=center>" + 
                e.features[0].properties.number + 
                "</h2><h4 align=center>" + 
                e.features[0].properties.name + 
                "</h4>")
            .addTo(map);
    });

    map.on('mouseleave', 'point', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });

    function animate() {
        // Update point geometry to a new position based on counter denoting
        // the index to access the arc.
        point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[counter];

        // Update the source with this new data.
        map.getSource('point').setData(point);

        // Request the next frame of animation so long as destination has not
        // been reached.
        if (point.features[0].geometry.coordinates[0] !== finish[0]) {
            requestAnimationFrame(animate);
        }

        counter = counter + 1;
    }

    document.getElementById('replay').addEventListener('click', function() {
        // Set the coordinates of the original point back to origin
        point.features[0].geometry.coordinates = origin;

        // Update the source layer
        map.getSource('point').setData(point);

        // Reset the counter
        counter = 0;

        // Restart the animation.
        animate();
    });

    // Start the animation.
    // animate(counter);
});
</script>

</body>
</html>
